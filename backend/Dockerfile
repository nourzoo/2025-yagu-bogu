# --- Build stage ---
FROM amazoncorretto:21 AS build
WORKDIR /workspace

# Gradle ìºì‹œ ìµœì í™”: wrapper/gradle ê´€ë ¨ íŒŒì¼ì„ ë¨¼ì € ë³µì‚¬
COPY gradlew gradlew
COPY gradle gradle
COPY build.gradle settings.gradle gradle.properties* ./
# ì†ŒìŠ¤ëŠ” ë§ˆì§€ë§‰ì— ë³µì‚¬ (ìºì‹œ í™œìš©)
RUN sed -i 's/\r$//' gradlew && chmod +x gradlew

# ğŸ”¥ Gradle ìºì‹œ ë§ˆìš´íŠ¸ (wrapper / caches ë¶„ë¦¬ ê¶Œì¥)
RUN --mount=type=cache,target=/root/.gradle/wrapper \
    --mount=type=cache,target=/root/.gradle/caches \
    ./gradlew --no-daemon dependencies --stacktrace --info

COPY src src

# ë¹Œë“œ
RUN --mount=type=cache,target=/root/.gradle/wrapper \
    --mount=type=cache,target=/root/.gradle/caches \
    ./gradlew --no-daemon -x test bootJar


# --- Run stage ---
FROM amazoncorretto:21-alpine AS runtime
WORKDIR /app
ENV TZ=Asia/Seoul
ENV JAVA_OPTS="-XX:MaxRAMPercentage=75 -XX:+UseG1GC"

# ---- ìµœì¢… ì´ë¯¸ì§€ 1: ë„ì»¤-ë‚´ë¶€ ë¹Œë“œ ì‚¬ìš© ----
FROM runtime AS image-from-build
COPY --from=build /workspace/build/libs/*.jar /app/app.jar
ENTRYPOINT ["java","-jar","/app/app.jar"]

# ---- ìµœì¢… ì´ë¯¸ì§€ 2: ì™¸ë¶€(JAR) í¬ì¥ ì „ìš© ----
FROM runtime AS image-from-jar
# CIì—ì„œ ./gradlew -x test bootJar ë¡œ ë§Œë“  ì‚°ì¶œë¬¼ì„ ì‚¬ìš©
COPY build/libs/*.jar /app/app.jar
ENTRYPOINT ["java","-jar","/app/app.jar"]
