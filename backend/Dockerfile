# --- Build stage ---
FROM amazoncorretto:21 AS build
WORKDIR /workspace

# Gradle ìºì‹œ ìµœì í™”: wrapper/gradle ê´€ë ¨ íŒŒì¼ì„ ë¨¼ì € ë³µì‚¬
COPY gradlew gradlew
COPY gradle gradle
COPY build.gradle settings.gradle ./
# ì†ŒìŠ¤ëŠ” ë§ˆì§€ë§‰ì— ë³µì‚¬ (ìºì‹œ í™œìš©)
RUN sed -i 's/\r$//' gradlew && chmod +x gradlew

# ğŸ”¥ Gradle ìºì‹œ ë§ˆìš´íŠ¸ (wrapper / caches ë¶„ë¦¬ ê¶Œì¥)
RUN --mount=type=cache,target=/root/.gradle/wrapper \
    --mount=type=cache,target=/root/.gradle/caches \
    ./gradlew --no-daemon dependencies || true \

COPY src src

# Gradle 8.14.3 ë³´ì¥ (wrapper ë²„ì „ í™•ì¸)
# RUN ./gradlew wrapper --gradle-version 8.14.3 --no-daemon

# ë¹Œë“œ
RUN --mount=type=cache,target=/root/.gradle/wrapper \
    --mount=type=cache,target=/root/.gradle/caches \
    ./gradlew --no-daemon -x test bootJar

# --- Run stage ---
FROM amazoncorretto:21-alpine

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
# Dockerfileì—ëŠ” JVM ì˜µì…˜, í”„ë¡œí•„ ì •ë„ë§Œ ê¸°ë³¸ê°’ìœ¼ë¡œ
ENV TZ=Asia/Seoul
ENV JAVA_OPTS="-XX:MaxRAMPercentage=75 -XX:+UseG1GC"

WORKDIR /app

# ë¹Œë“œ ê²°ê³¼ ë³µì‚¬
COPY --from=build /workspace/build/libs/*SNAPSHOT.jar /app/app.jar

# ì‹¤í–‰
ENTRYPOINT ["sh","-c","java $JAVA_OPTS -jar /app/app.jar"]
